# =============================================================================
# Release Workflow
# =============================================================================
# This workflow automates the release process using release-please.
#
# How it works:
#   1. On every push to main, release-please analyzes commit messages
#   2. It creates/updates a "Release PR" with version bumps and changelog
#   3. When the Release PR is merged, this workflow:
#      - Verifies all version files are in sync
#      - Builds the production bundle
#      - Uploads release assets to the GitHub Release
#
# Required Secrets:
#   - RELEASE_TOKEN: GitHub PAT with contents:write and pull-requests:write
#
# Jobs:
#   - release-please:     Manages release PR and creates GitHub releases
#   - build-and-publish:  Builds and uploads assets when a release is created
#
# See: https://github.com/googleapis/release-please
# =============================================================================

name: Release

on:
  # Trigger on pushes to main (analyzes commits for release)
  push:
    branches:
      - main
  # Allow manual triggering for testing or re-runs
  workflow_dispatch:
    inputs:
      publish:
        description: Publish
        required: true
        type: boolean
        default: true

# Required permissions for release-please to create PRs and releases
permissions:
  contents: write
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Release Please
  # ---------------------------------------------------------------------------
  # Analyzes conventional commits since last release and either:
  #   - Creates/updates a Release PR with version bump and changelog, OR
  #   - Creates a GitHub Release when the Release PR is merged
  # ---------------------------------------------------------------------------
  release-please:
    name: Manage Release PR
    runs-on: ubuntu-latest
    outputs:
      # Expose outputs for downstream jobs
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          # Use PAT to allow triggering other workflows
          # Configuration is read from release-please-config.json
          token: ${{ secrets.RELEASE_TOKEN }}

      # Log the release status for debugging
      - name: Output Status
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

      # Fix release title to remove "v" prefix (Obsidian requires exact version)
      - name: Fix Release Title
        if: steps.release.outputs.release_created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh release edit ${{ steps.release.outputs.tag_name }} \
            --title "${{ steps.release.outputs.version }}"
          echo "Updated release title to: ${{ steps.release.outputs.version }}"

  # ---------------------------------------------------------------------------
  # Build and Publish
  # ---------------------------------------------------------------------------
  # Runs only when a release is created (Release PR was merged).
  # Verifies versions, builds the plugin, and uploads release assets.
  # ---------------------------------------------------------------------------
  build-and-publish:
    name: Build and Publish
    needs: release-please
    # Only run when release-please actually created a release
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          # Use PAT to allow pushing commits back to the repo
          token: ${{ secrets.RELEASE_TOKEN }}

      # ---------------------------------------------------------------------------
      # Verify Version Consistency
      # ---------------------------------------------------------------------------
      # Ensures release-please correctly updated all version files.
      # Fails the build if versions are out of sync.
      # ---------------------------------------------------------------------------
      - name: Verify Version Consistency
        run: |
          EXPECTED="${{ needs.release-please.outputs.version }}"
          PKG_VERSION=$(jq -r '.version' package.json)
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)

          echo "Expected version: $EXPECTED"
          echo "package.json:     $PKG_VERSION"
          echo "manifest.json:    $MANIFEST_VERSION"

          ERRORS=0
          if [ "$PKG_VERSION" != "$EXPECTED" ]; then
            echo "::error::package.json version ($PKG_VERSION) does not match release version ($EXPECTED)"
            ERRORS=$((ERRORS + 1))
          fi
          if [ "$MANIFEST_VERSION" != "$EXPECTED" ]; then
            echo "::error::manifest.json version ($MANIFEST_VERSION) does not match release version ($EXPECTED)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "::error::Version mismatch detected. Check release-please-config.json extra-files configuration."
            exit 1
          fi
          echo "::notice::All versions match: $EXPECTED"

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - run: npm ci

      # Build the production bundle
      - name: Build Production Bundle
        run: npm run build

      # Verify all required Obsidian plugin files exist
      - name: Verify Build Artifacts
        run: |
          for file in main.js manifest.json styles.css; do
            [ -f "$file" ] || { echo "[X] $file not found"; exit 1; }
          done
          echo "[OK] All release artifacts present"

      # ---------------------------------------------------------------------------
      # Upload Release Assets
      # ---------------------------------------------------------------------------
      # Uploads the built plugin files to the GitHub Release.
      # These files are what users download when installing the plugin.
      # ---------------------------------------------------------------------------
      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            main.js \
            manifest.json \
            styles.css \
            --clobber

      # Print release summary
      - name: Release Summary
        run: |
          echo "Release ${{ needs.release-please.outputs.tag_name }} published"
          echo "Assets: main.js, manifest.json, styles.css"
